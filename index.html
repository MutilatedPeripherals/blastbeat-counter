<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BlastViz</title>
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/wavesurfer.js@7/dist/wavesurfer.min.js"></script>
    <script src="https://unpkg.com/wavesurfer.js@7/dist/plugins/regions.min.js"></script>
    <script src="https://unpkg.com/wavesurfer.js@7/dist/plugins/timeline.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        #controls { margin-top: 10px; display: none; }
        button { margin-right: 10px; }
        #waveform { width: 100%; height: 150px; margin-top: 20px; }
        #timeline { height: 20px; }
        #audioPath { margin-top: 10px; font-style: italic; color: #444; }
    </style>
</head>
<body>
<h2>BlastViz</h2>
<h4>Blastbeat Detection Visualizer</h4>
<hr>
<p><i><strong>Warning:</strong> This is a work in progress. This visualizer expects a ZIP file containing an audio file
    (MP3 or WAV)
    and a JSON file with the identified blast-beat sections.</i>
</p>
<p>Expected JSON structure:</p>
<pre>
{
  "blast_beats": [
    {"start_time": 12.5, "end_time": 15.0},
    {"start_time": 30.0, "end_time": 32.5}
  ]
}
</pre>
<hr>
<div>
    <label>Load ZIP (audio + JSON):</label>
    <input type="file" id="zipInput" accept=".zip">
</div>
<div id="audioPath"></div>
<div id="waveform"></div>
<div id="timeline"></div>
<div id="controls">
    <button id="play">▶️</button>
</div>
<script>
    let wavesurfer = null
    let audioReady = false
    const playBtn = document.getElementById('play')

    function initWaveSurfer(audioFile, intervals) {
      if (wavesurfer) {
        wavesurfer.destroy()
        document.getElementById('waveform').innerHTML = ""
        document.getElementById('timeline').innerHTML = ""
      }
      const regions = WaveSurfer.Regions.create()
      const timeline = WaveSurfer.Timeline.create({
        container: '#timeline',
        primaryLabelInterval: 5,
        secondaryLabelInterval: 1,
        timeInterval: 1,
        formatTimeCallback: sec => {
          const minutes = Math.floor(sec / 60)
          const seconds = Math.floor(sec % 60)
          return `${minutes}:${seconds.toString().padStart(2, "0")}`
        }
      })
      wavesurfer = WaveSurfer.create({
        container: '#waveform',
        waveColor: '#1f77b4',
        progressColor: '#2ca02c',
        cursorColor: '#ff0000',
        height: 150,
        plugins: [regions, timeline]
      })
      wavesurfer.load(audioFile)
      wavesurfer.on('ready', () => {
        audioReady = true
        document.getElementById('controls').style.display = 'block'
        intervals.forEach(({ start_time, end_time }) => {
          regions.addRegion({
            start: start_time,
            end: end_time,
            color: 'rgba(255, 0, 0, 0.4)',
            drag: false,
            resize: false
          })
        })
      })
      wavesurfer.on('play', () => playBtn.textContent = '⏸️')
      wavesurfer.on('pause', () => playBtn.textContent = '▶️')
    }

    document.getElementById('zipInput').addEventListener('change', async e => {
      const file = e.target.files[0]
      if (!file) return
      const zip = await JSZip.loadAsync(file)
      const jsonFileName = Object.keys(zip.files).find(name => name.endsWith('.json'))
      if (!jsonFileName) { alert("No JSON found in zip"); return; }
      const jsonData = await zip.files[jsonFileName].async('string')
      const config = JSON.parse(jsonData)
      const intervals = config.blast_beats || []
      const audioFileName = Object.keys(zip.files).find(name => /\.(mp3|wav)$/i.test(name))
      if (!audioFileName) { alert("No audio file found in zip"); return; }
      const audioBlob = await zip.files[audioFileName].async('blob')
      const audioURL = URL.createObjectURL(audioBlob)
      document.getElementById('audioPath').textContent = "Loaded audio: " + audioFileName
      initWaveSurfer(audioURL, intervals)
    })

    playBtn.addEventListener('click', () => {
      if (wavesurfer && audioReady) wavesurfer.playPause()
    })

    document.addEventListener('keydown', e => {
      if (e.code === 'Space' && audioReady) {
        e.preventDefault()
        if (wavesurfer) wavesurfer.playPause()
      }
    })
</script>
</body>
</html>
